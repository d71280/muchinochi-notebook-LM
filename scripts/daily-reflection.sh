#!/bin/bash
# ç§‹å±± å¤§è¼ã®1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Šè‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

set -e

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(dirname "$0")/.."

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
LOG_FILE="$HOME/Library/Logs/daily-reflection.log"
echo "========================================" >> "$LOG_FILE"
echo "Started at: $(date)" >> "$LOG_FILE"

# æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆJSTï¼‰
YESTERDAY=$(date -v-1d "+%Yå¹´%mæœˆ%dæ—¥")
DATE_ISO=$(date -v-1d "+%Y-%m-%d")

echo "Generating reflection for: $YESTERDAY" >> "$LOG_FILE"

# NotebookLM ã«è³ªå•
QUESTION="${YESTERDAY}ã®ç§‹å±±å¤§è¼ã®1æ—¥ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦ãã ã•ã„ã€‚ä¸»ãªæ´»å‹•ã€ä»•äº‹ã®é€²æ—ã€å­¦ç¿’å†…å®¹ã€é‹å‹•ã€é£Ÿäº‹ã€ç¡çœ ãªã©ã®è¨˜éŒ²ã‚’å…·ä½“çš„ã«æ•™ãˆã¦ãã ã•ã„ã€‚"

echo "Querying NotebookLM..." >> "$LOG_FILE"

cd .claude/skills/notebooklm

# NotebookLM ã‚¹ã‚­ãƒ«ã‚’å®Ÿè¡Œ
ANSWER=$(python3 scripts/run.py ask_question.py \
  --question "$QUESTION" \
  --notebook-url "https://notebooklm.google.com/notebook/6c1ba7cc-2bea-4fc6-a4e1-884e59fa9c5f" \
  2>&1 | tee -a "$LOG_FILE")

cd ../../..

# ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
echo "Generating report..." >> "$LOG_FILE"

cat > "reports/daily-reflection-${DATE_ISO}.md" << EOF
# ðŸ“… ç§‹å±± å¤§è¼ã®1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Š - ${YESTERDAY}

$(echo "$ANSWER" | sed -n '/Question:/,/EXTREMELY IMPORTANT:/p' | sed '$d')

---

ðŸ”— **NotebookLM ã‚½ãƒ¼ã‚¹**: [ç§‹å±±å¤§è¼ã®ãƒ©ã‚¤ãƒ•ãƒ­ã‚°ãƒ»æˆ¦ç•¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹](https://notebooklm.google.com/notebook/6c1ba7cc-2bea-4fc6-a4e1-884e59fa9c5f)

ðŸ’¡ **ç”Ÿæˆæ—¥æ™‚**: $(date "+%Y-%m-%d %H:%M")

ðŸ¤– **Powered by NotebookLM + Claude Code**
EOF

# ã‚µãƒžãƒªãƒ¼ç”Ÿæˆï¼ˆæœ€åˆã®200æ–‡å­—ï¼‰
echo "$ANSWER" | sed -n '/Question:/,/EXTREMELY IMPORTANT:/p' | sed '$d' | head -n 5 > "reports/daily-summary.txt"

echo "Reports generated successfully" >> "$LOG_FILE"

# Git ã«ã‚³ãƒŸãƒƒãƒˆ
echo "Committing to Git..." >> "$LOG_FILE"
git add reports/
git commit -m "Add daily reflection for ${DATE_ISO}

Generated by local automation

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>" || echo "Nothing to commit" >> "$LOG_FILE"

git push origin main >> "$LOG_FILE" 2>&1 || echo "Push failed" >> "$LOG_FILE"

# Google Chat ã«é€šçŸ¥
echo "Sending notification to Google Chat..." >> "$LOG_FILE"

SUMMARY=$(cat reports/daily-summary.txt | LC_ALL=C tr '\n' ' ' | sed 's/"/\\"/g' | head -c 300)

curl -X POST \
  -H 'Content-Type: application/json' \
  -d "{\"text\":\"ðŸ“Š *ç§‹å±± å¤§è¼ã®1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Š*\n\nðŸ“… æ—¥ä»˜: ${YESTERDAY}\n\n${SUMMARY}...\n\nðŸ“„ è©³ç´°: https://github.com/d71280/muchinochi-notebook-LM/blob/main/reports/daily-reflection-${DATE_ISO}.md\"}" \
  "https://chat.googleapis.com/v1/spaces/AAQA1C_OnvI/messages?key=AIzaSyDdI0hCZtE6vySjMm-WEfRq3CPzqKqqsHI&token=LHawZ6Z-rzBnUouh6V9lhPa2-W0RJuFO4C4P240H990" \
  >> "$LOG_FILE" 2>&1

echo "Completed at: $(date)" >> "$LOG_FILE"
echo "âœ… Daily reflection completed successfully!" >> "$LOG_FILE"
