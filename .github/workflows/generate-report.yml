name: Generate Notebook LM Report

on:
  # ÊâãÂãï„Éà„É™„Ç¨„Éº
  workflow_dispatch:
    inputs:
      source_directory:
        description: 'Source directory containing documents'
        required: false
        default: './sources'
      report_format:
        description: 'Report format (markdown/json/html)'
        required: false
        default: 'markdown'
      notebook_name:
        description: 'Name for the Notebook LM notebook'
        required: false
        default: ''

  # „Éó„É´„É™„ÇØ„Ç®„Çπ„ÉàÊôÇ„Å´„ÇÇÂÆüË°åÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
  pull_request:
    branches: [main]
    paths:
      - 'sources/**'
      - 'docs/**'

  # ÂÆöÊúüÂÆüË°åÔºàÊØéÈÄ±ÊúàÊõúÊó•„ÅÆÂçàÂâç9ÊôÇÔºâ
  schedule:
    - cron: '0 0 * * 1'

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth google-auth-oauthlib google-auth-httplib2

      - name: Authenticate with Google Cloud
        if: env.NOTEBOOKLM_PROJECT_ID != ''
        run: |
          # Google CloudË™çË®º„ÅÆË®≠ÂÆö
          # „Çµ„Éº„Éì„Çπ„Ç¢„Ç´„Ç¶„É≥„Éà„Ç≠„Éº„Åå„Ç∑„Éº„ÇØ„É¨„ÉÉ„Éà„Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
          if [ -n "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}" ]; then
            echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > /tmp/gcloud-key.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcloud-key.json
          fi
        env:
          NOTEBOOKLM_PROJECT_ID: ${{ secrets.NOTEBOOKLM_PROJECT_ID }}

      - name: Run Claude Code Action
        id: claude-report
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number || 'N/A' }}
            WORKFLOW: Generate Notebook LM Report

            Please generate a comprehensive report using the Notebook LM integration:

            1. Use the /generate-notebooklm-report skill with the following parameters:
               - Source directory: ${{ github.event.inputs.source_directory || './sources' }}
               - Format: ${{ github.event.inputs.report_format || 'markdown' }}
               - Notebook name: ${{ github.event.inputs.notebook_name || format('Report_{0}', github.run_number) }}

            2. After generating the report:
               - Verify the output was created successfully
               - Display a summary of the sources analyzed
               - Show the path to the generated report

            3. Create a commit with the generated report files

            The .claude/skills/ directory contains the necessary skill for this task.

          claude_args: '--allowed-tools "Skill,Bash,Read,Write,Edit,Glob,Grep,Task"'

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: notebooklm-report-${{ github.run_number }}
          path: |
            reports/
            !reports/**/*.tmp
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryPath = 'reports/latest_report_summary.json';

            let comment = '## üìä Notebook LM Report Generated\n\n';

            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              comment += `- **Sources analyzed**: ${summary.sources_count}\n`;
              comment += `- **Format**: ${summary.format}\n`;
              comment += `- **Generated**: ${summary.timestamp}\n`;
              comment += `\n[View full report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            } else {
              comment += 'Report generation completed. Check artifacts for details.\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Notification on failure
        if: failure()
        run: |
          echo "‚ùå Report generation failed"
          echo "Please check the logs for details"
          exit 1

env:
  NOTEBOOKLM_PROJECT_ID: ${{ secrets.NOTEBOOKLM_PROJECT_ID }}
  NOTEBOOKLM_LOCATION: ${{ secrets.NOTEBOOKLM_LOCATION || 'us-central1' }}
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-key.json
