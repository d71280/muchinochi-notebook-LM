name: Daily Reflection with Notebook LM

on:
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç„¡åŠ¹åŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã«ç§»è¡Œï¼‰
  # schedule:
  #   - cron: '0 21 * * *'

  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿æœ‰åŠ¹
  workflow_dispatch:
    inputs:
      date:
        description: 'æŒ¯ã‚Šè¿”ã‚Šã®æ—¥ä»˜ï¼ˆYYYY-MM-DDå½¢å¼ã€ç©ºæ¬„ã§æ˜¨æ—¥ï¼‰'
        required: false
        default: ''

jobs:
  daily-reflection:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth google-auth-oauthlib google-auth-httplib2

      - name: Install Xvfb and browser dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            libgbm1 \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64

      - name: Authenticate with Google Cloud
        if: env.NOTEBOOKLM_PROJECT_ID != ''
        run: |
          # Google Cloudèªè¨¼ã®è¨­å®š
          if [ -n "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}" ]; then
            echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > /tmp/gcloud-key.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcloud-key.json
          fi
        env:
          NOTEBOOKLM_PROJECT_ID: ${{ secrets.NOTEBOOKLM_PROJECT_ID }}

      - name: Set reflection date
        id: date
        run: |
          if [ -n "${{ github.event.inputs.date }}" ]; then
            REFLECTION_DATE="${{ github.event.inputs.date }}"
          else
            # æ˜¨æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆJSTã§è¨ˆç®—ï¼‰
            REFLECTION_DATE=$(TZ='Asia/Tokyo' date -d 'yesterday' '+%Y-%m-%d' 2>/dev/null || TZ='Asia/Tokyo' date -v-1d '+%Y-%m-%d')
          fi
          echo "reflection_date=$REFLECTION_DATE" >> $GITHUB_OUTPUT
          echo "Reflection date: $REFLECTION_DATE"

      - name: Setup NotebookLM authentication
        run: |
          # Create directory structure
          mkdir -p .claude/skills/notebooklm/data/browser_state

          # Decode and save state.json
          echo "${{ secrets.NOTEBOOKLM_STATE_JSON }}" | base64 -d > .claude/skills/notebooklm/data/browser_state/state.json

          # Decode and save library.json
          echo "${{ secrets.NOTEBOOKLM_LIBRARY_JSON }}" | base64 -d > .claude/skills/notebooklm/data/library.json

          # Verify files were created
          if [ -f ".claude/skills/notebooklm/data/browser_state/state.json" ] && [ -f ".claude/skills/notebooklm/data/library.json" ]; then
            echo "âœ… NotebookLM authentication and library files created"
          else
            echo "âŒ Failed to create required files"
            exit 1
          fi

      - name: Start Xvfb
        run: |
          # Start Xvfb on display :99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2
          echo "âœ… Xvfb started on display :99"

      - name: Run Claude Code Action for Daily Reflection
        id: claude-reflection
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          show_full_output: true
          prompt: |
            REPO: ${{ github.repository }}
            WORKFLOW: Daily Reflection for ç§‹å±± å¤§è¼
            DATE: ${{ steps.date.outputs.reflection_date }}

            # ç§‹å±± å¤§è¼ã®1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Š

            NotebookLMã‚’ä½¿ç”¨ã—ã¦ã€${{ steps.date.outputs.reflection_date }}ã®æ´»å‹•ã‚’æŒ¯ã‚Šè¿”ã‚‹è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            ## ã‚¿ã‚¹ã‚¯

            1. **NotebookLMã‚¹ã‚­ãƒ«ã®å®Ÿè¡Œ**
               - `/notebooklm` ã‚¹ã‚­ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€sources/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’åˆ†æ
               - æ—¥ä»˜: ${{ steps.date.outputs.reflection_date }}
               - ä»¥ä¸‹ã®è³ªå•ã«å¯¾ã™ã‚‹è©³ç´°ãªå›ç­”ã‚’å–å¾—ï¼š
                 * ã“ã®æ—¥ã®ä¸»ãªæ´»å‹•ã‚„æˆæœã¯ä½•ã§ã—ãŸã‹ï¼Ÿ
                 * é‡è¦ãªæ±ºå®šã‚„å­¦ã³ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ
                 * é€²è¡Œä¸­ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çŠ¶æ³ã¯ï¼Ÿ
                 * æ˜æ—¥ä»¥é™ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ ã¯ï¼Ÿ

            2. **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ**
               - è©³ç´°ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆã‚’ `reports/daily-reflection-${{ steps.date.outputs.reflection_date }}.md` ã«ç”Ÿæˆ
               - ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å«ã‚ã‚‹ï¼š
                 * ğŸ“… æ—¥ä»˜ã¨æ¦‚è¦
                 * ğŸ¯ ä¸»ãªæˆæœ
                 * ğŸ“ é‡è¦ãªå­¦ã³
                 * ğŸ”„ é€²è¡Œä¸­ã®ã‚¿ã‚¹ã‚¯
                 * âœ… å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯
                 * ğŸ“Œ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 

            3. **ã‚µãƒãƒªãƒ¼ç”Ÿæˆ**
               - Google Chaté€šçŸ¥ç”¨ã®ç°¡æ½”ãªã‚µãƒãƒªãƒ¼ï¼ˆ200-300æ–‡å­—ï¼‰ã‚’ `reports/daily-summary.txt` ã«ç”Ÿæˆ
               - çµµæ–‡å­—ã‚’ä½¿ã£ã¦èª­ã¿ã‚„ã™ã

            å¿…è¦ãªãƒ„ãƒ¼ãƒ«: Skill, Bash, Read, Write, Edit, Glob, Grep

          claude_args: '--allowed-tools "Skill,Bash,Read,Write,Edit,Glob,Grep,Task"'
        env:
          DISPLAY: :99

      - name: Read generated summary
        id: summary
        run: |
          if [ -f "reports/daily-summary.txt" ]; then
            SUMMARY=$(cat reports/daily-summary.txt)
            # GitHubã®ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆæ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "summary=æŒ¯ã‚Šè¿”ã‚Šãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚è©³ç´°ã¯ãƒªãƒã‚¸ãƒˆãƒªã‚’ã”ç¢ºèªãã ã•ã„ã€‚" >> $GITHUB_OUTPUT
          fi

      - name: Notify to Google Chat
        if: always()
        run: |
          WEBHOOK_URL="${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"
          DATE="${{ steps.date.outputs.reflection_date }}"
          SUMMARY="${{ steps.summary.outputs.summary }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          RUN_URL="$REPO_URL/actions/runs/${{ github.run_id }}"

          # Escape summary for JSON (replace newlines and quotes)
          SUMMARY_ESCAPED=$(echo "$SUMMARY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | tr '\n' ' ')

          # Google Chatç”¨ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ§‹ç¯‰
          cat > /tmp/chat-message.json <<EOF
          {
            "text": "ğŸ“Š *ç§‹å±± å¤§è¼ã®1æ—¥ã®æŒ¯ã‚Šè¿”ã‚Š*",
            "cards": [{
              "header": {
                "title": "Daily Reflection: ${DATE}",
                "subtitle": "Notebook LM ã«ã‚ˆã‚‹ãƒ¬ãƒãƒ¼ãƒˆ",
                "imageUrl": "https://www.gstatic.com/images/branding/product/2x/googleg_48dp.png"
              },
              "sections": [{
                "widgets": [{
                  "textParagraph": {
                    "text": "${SUMMARY_ESCAPED}"
                  }
                }, {
                  "buttons": [{
                    "textButton": {
                      "text": "ğŸ“„ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹",
                      "onClick": {
                        "openLink": {
                          "url": "${REPO_URL}/blob/main/reports/daily-reflection-${DATE}.md"
                        }
                      }
                    }
                  }, {
                    "textButton": {
                      "text": "ğŸ” ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’è¦‹ã‚‹",
                      "onClick": {
                        "openLink": {
                          "url": "${RUN_URL}"
                        }
                      }
                    }
                  }]
                }]
              }]
            }]
          }
          EOF

          # Google Chatã«é€ä¿¡
          curl -X POST \
            -H 'Content-Type: application/json' \
            -d @/tmp/chat-message.json \
            "$WEBHOOK_URL"

          echo "âœ… Google Chat ã«é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ"

      - name: Commit and push report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add reports/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add daily reflection for ${{ steps.date.outputs.reflection_date }}

          Generated by GitHub Actions

          Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }}
            echo "âœ… ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          fi

      - name: Check if reports exist
        id: check_reports
        run: |
          if [ -f "reports/daily-reflection-${{ steps.date.outputs.reflection_date }}.md" ] || [ -f "reports/daily-summary.txt" ]; then
            echo "reports_exist=true" >> $GITHUB_OUTPUT
          else
            echo "reports_exist=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        if: steps.check_reports.outputs.reports_exist == 'true'
        with:
          name: daily-reflection-${{ steps.date.outputs.reflection_date }}
          path: |
            reports/daily-reflection-${{ steps.date.outputs.reflection_date }}.md
            reports/daily-summary.txt
          retention-days: 90

      - name: Cleanup Xvfb
        if: always()
        run: |
          if [ -n "$XVFB_PID" ]; then
            kill $XVFB_PID 2>/dev/null || true
            echo "âœ… Xvfb stopped"
          fi

      - name: Notification on failure
        if: failure()
        run: |
          WEBHOOK_URL="${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}"

          curl -X POST \
            -H 'Content-Type: application/json' \
            -d '{"text": "âŒ *Daily Reflection Failed*\n\næ—¥æ¬¡æŒ¯ã‚Šè¿”ã‚Šã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
            "$WEBHOOK_URL"

          exit 1

env:
  NOTEBOOKLM_PROJECT_ID: ${{ secrets.NOTEBOOKLM_PROJECT_ID }}
  NOTEBOOKLM_LOCATION: ${{ secrets.NOTEBOOKLM_LOCATION || 'us-central1' }}
  GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcloud-key.json
